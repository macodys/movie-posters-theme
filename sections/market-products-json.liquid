{%- comment -%}
  Server-rendered JSON of product handles visible to the current visitor/market.
  Access via:
   - /?section_id=market-products-json
   - /collections/<handle>?section_id=market-products-json
   - /collections/all?section_id=market-products-json
  Output is JSON so the client can parse reliably.
{%- endcomment -%}
{%- assign coll = collection -%}
{%- if coll == nil -%}
  {%- assign coll = collections['all'] -%}
{%- endif -%}
{
  "market": {{ localization.market.handle | default: localization.country.iso_code | downcase | json }},
  "collection": {{ coll.handle | default: 'all' | json }},
  "products": [
    {%- if coll -%}
      {%- paginate coll.products by 250 -%}
        {%- for product in coll.products -%}
          {%- if forloop.index0 > 0 -%},{%- endif -%}
          {"handle": {{ product.handle | json }}, "id": {{ product.id }}, "title": {{ product.title | json }}}
        {%- endfor -%}
      {%- endpaginate -%}
    {%- endif -%}
  ]
}

